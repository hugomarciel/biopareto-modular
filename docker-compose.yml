# docker-compose.yml
version: '3.8'

services:
  # 1. SERVICIO DE LA APLICACIN (DASH/GUNICORN)
  app:
    # Usando la imagen que subiste a Docker Hub (hugomarciel/pareto-app:v2.0-ssl)
    #image: hugomarciel/biopareto:V1.0
    image: hugomarciel/pareto-app:v2.0-ssl
    container_name: biopareto_app
    restart: unless-stopped
    # El puerto interno 8050 no se expone al exterior, solo a Nginx
    networks:
      - biopareto_network
    
  # 2. SERVICIO DEL PROXY INVERSO (NGINX)
  nginx:
    image: nginx:stable-alpine
    container_name: biopareto_nginx
    restart: unless-stopped
    ports:
      - "80:80"   # HTTP: Necesario para Certbot y redirecci贸n
      - "443:443" # HTTPS: Tr谩fico seguro principal
    volumes:
      # Configuraci贸n del proxy
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      # Vol煤menes compartidos con Certbot para los certificados
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    depends_on:
      - app
    networks:
      - biopareto_network

  # 3. SERVICIO DE GESTIN DE CERTIFICADOS (CERTBOT)
  certbot:
    image: certbot/certbot
    container_name: biopareto_certbot
    volumes:
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    #  CORRECCIN APLICADA: Se elimin贸 el "entrypoint" para evitar el error de sintaxis/interpolaci贸n.
    # La renovaci贸n se manejar谩 por CRONJOB en el servidor de producci贸n.
    networks:
      - biopareto_network

# DEFINICIN DE VOLMENES Y RED
volumes:
  certbot_webroot: # Para el desaf铆o http-01 de Certbot
  certbot_certs:   # Para persistir los certificados (CRUCIAL)

networks:
  biopareto_network:
    driver: bridge